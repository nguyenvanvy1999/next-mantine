// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Better Auth Core Tables
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Better Auth Admin Plugin fields
  role          String    @default("user")
  banned        Boolean   @default(false)
  banReason     String?
  banExpires    DateTime?
  
  sessions                Session[]
  accounts                AuthAccount[]
  
  // Business relations
  userAccounts                 Account[]                 @relation("userAccounts")
  userCategories               Category[]                 @relation("userCategories")
  userInvestments              Investment[]               @relation("userInvestments")
  userTransactions             Transaction[]             @relation("userTransactions")
  userInvestmentContributions InvestmentContribution[]  @relation("userInvestmentContributions")
  userInvestmentValuations     InvestmentValuation[]     @relation("userInvestmentValuations")
  userBudgets                  Budget[]                   @relation("userBudgets")
  userEntities                 Entity[]                   @relation("userEntities")
  userRecurringTransactions    RecurringTransaction[]    @relation("userRecurringTransactions")
  userInvestmentTrades         InvestmentTrade[]         @relation("userInvestmentTrades")
  userHoldings                 Holding[]                  @relation("userHoldings")
  userTags                     Tag[]                     @relation("userTags")
  userEvents                   Event[]                   @relation("userEvents")
  userGoals                    Goal[]                    @relation("userGoals")
  
  baseCurrency                 Currency? @relation("UserBaseCurrency", fields: [baseCurrencyId], references: [id])
  baseCurrencyId               String?  @map("base_currency_id")
  
  @@map("user")
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  impersonatedBy String?
  
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("session")
}

model AuthAccount {
  id                String   @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  idToken           String?
  accessTokenExpiresAt DateTime?
  refreshTokenExpiresAt DateTime?
  scope             String?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([providerId, accountId])
  @@index([userId], map: "auth_account_userId_idx")
  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([identifier, value])
  @@map("verification")
}

// ============================================
// Business Enums
// ============================================

// Account types for categorizing user financial accounts
enum AccountType {
  cash
  bank
  credit_card
  investment
}

// Category types for organizing transactions
enum CategoryType {
  expense
  income
  transfer
  investment
  loan
}

// Transaction types representing different financial operations
enum TransactionType {
  income
  expense
  transfer
  loan_given
  loan_received
  repay_debt
  collect_debt
  investment
}

// Types of investment assets
enum InvestmentAssetType {
  coin
  ccq
  custom
}

// Investment tracking modes: priced (auto price fetching) or manual entry
enum InvestmentMode {
  priced
  manual
}

// Entity types for tracking individuals or organizations
enum EntityType {
  individual
  organization
}

// Budget period intervals
enum BudgetPeriod {
  daily
  monthly
  quarterly
  yearly
  none
}

// Frequencies for recurring transactions
enum RecurringFrequency {
  daily
  weekly
  monthly
}

// Trade side for investment transactions
enum TradeSide {
  buy
  sell
}

// Investment contribution types
enum ContributionType {
  deposit
  withdrawal
}

// Proxy protocol types
enum ProxyProtocol {
  http
  https
  socks4
  socks5
}

// Data types for application settings
enum SettingDataType {
  string
  number
  boolean
  date
  json
}

// ============================================
// Business Models
// ============================================

// Currency reference data
model Currency {
  id       String   @id
  code     String   @unique
  name     String
  symbol   String?
  isActive Boolean  @default(true) @map("is_active")
  created  DateTime @default(now())
  modified DateTime @updatedAt

  accounts                            Account[]
  investments                         Investment[]             @relation("InvestmentCurrency")
  investmentsBaseCurrency             Investment[]             @relation("InvestmentBaseCurrency")
  transactions                        Transaction[]
  recurringTransactions               RecurringTransaction[]
  investmentTrades                   InvestmentTrade[]
  investmentTradesBaseCurrency        InvestmentTrade[]        @relation("TradeBaseCurrency")
  investmentContributions             InvestmentContribution[]
  investmentContributionsBaseCurrency InvestmentContribution[] @relation("ContributionBaseCurrency")
  investmentValuations                InvestmentValuation[]
  investmentValuationsBaseCurrency    InvestmentValuation[]    @relation("ValuationBaseCurrency")
  goals                               Goal[]
  usersBaseCurrency                    User[]                  @relation("UserBaseCurrency")

  @@index([code], name: "currency_code_idx")
  @@map("currencies")
}

// User financial accounts (cash, bank, credit card, investment)
model Account {
  id               String      @id
  userId           String      @map("user_id")
  type             AccountType
  name             String
  currencyId       String      @map("currency_id")
  balance          Decimal     @default(0) @db.Decimal(30, 10)
  creditLimit      Decimal?    @map("credit_limit") @db.Decimal(30, 10)
  notifyOnDueDate  Boolean?    @map("notify_on_due_date")
  paymentDay       Int?        @map("payment_day")
  notifyDaysBefore Int?        @map("notify_days_before")
  meta             Json?
  created          DateTime    @default(now())
  modified         DateTime    @updatedAt

  currency                Currency                 @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user                    User                     @relation("userAccounts", fields: [userId], references: [id], onDelete: Cascade)
  transactions            Transaction[]            @relation("AccountTransactions")
  toTransactions          Transaction[]            @relation("ToAccountTransactions")
  recurringTransactions   RecurringTransaction[]
  investmentTrades        InvestmentTrade[]
  investmentContributions InvestmentContribution[]
  budgetAccounts          BudgetAccount[]
  goalAccounts            GoalAccount[]

  @@index([userId], name: "business_account_userId_idx")
  @@index([type], name: "account_type_idx")
  @@index([currencyId], name: "account_currencyId_idx")
  @@map("accounts")
}

// Hierarchical categories for organizing transactions
model Category {
  id       String       @id
  userId   String       @map("user_id")
  type     CategoryType
  name     String
  parentId String?      @map("parent_id")
  icon     String?
  color    String?
  isLocked Boolean      @default(false) @map("is_locked")

  created  DateTime @default(now())
  modified DateTime @updatedAt

  user                  User                   @relation("userCategories", fields: [userId], references: [id], onDelete: Cascade)
  parent                Category?              @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children              Category[]             @relation("CategoryHierarchy")
  transactions          Transaction[]
  budgets               Budget[]
  budgetCategories      BudgetCategory[]
  recurringTransactions RecurringTransaction[]

  @@unique([userId, name, type], name: "category_userId_name_type_unique")
  @@index([userId], name: "category_userId_idx")
  @@index([type], name: "category_type_idx")
  @@index([parentId], name: "category_parentId_idx")
  @@map("categories")
}

// Core financial transaction records
model Transaction {
  id                  String          @id
  userId              String          @map("user_id")
  accountId           String          @map("account_id")
  toAccountId         String?         @map("to_account_id")
  transferGroupId     String?         @map("transfer_group_id")
  isTransferMirror    Boolean         @default(false) @map("is_transfer_mirror")
  type                TransactionType
  categoryId          String          @map("category_id")
  investmentId        String?         @map("investment_id")
  entityId            String?         @map("entity_id")
  eventId             String?         @map("event_id")
  amount              Decimal         @db.Decimal(30, 10)
  currencyId          String          @map("currency_id")
  price               Decimal?        @db.Decimal(30, 10)
  priceInBaseCurrency Decimal?        @map("price_in_base_currency") @db.Decimal(30, 10)
  quantity            Decimal?        @db.Decimal(30, 10)
  fee                 Decimal         @default(0) @db.Decimal(30, 10)
  feeInBaseCurrency   Decimal?        @map("fee_in_base_currency") @db.Decimal(30, 10)
  date                DateTime
  dueDate             DateTime?       @map("due_date")
  note                String?
  receiptUrl          String?         @map("receipt_url")
  metadata            Json?
  created             DateTime        @default(now())
  modified            DateTime        @updatedAt

  currency   Currency         @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user       User             @relation("userTransactions", fields: [userId], references: [id], onDelete: Cascade)
  account    Account          @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: Cascade)
  toAccount  Account?         @relation("ToAccountTransactions", fields: [toAccountId], references: [id], onDelete: SetNull)
  category   Category         @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  investment Investment?      @relation(fields: [investmentId], references: [id], onDelete: SetNull)
  entity     Entity?          @relation(fields: [entityId], references: [id], onDelete: SetNull)
  event      Event?           @relation(fields: [eventId], references: [id], onDelete: SetNull)
  trade      InvestmentTrade? @relation("TransactionTrade")

  @@index([userId], name: "transaction_userId_idx")
  @@index([accountId], name: "transaction_accountId_idx")
  @@index([toAccountId], name: "transaction_toAccountId_idx")
  @@index([categoryId], name: "transaction_categoryId_idx")
  @@index([investmentId], name: "transaction_investmentId_idx")
  @@index([entityId], name: "transaction_entityId_idx")
  @@index([eventId], name: "transaction_eventId_idx")
  @@index([currencyId], name: "transaction_currencyId_idx")
  @@index([date], name: "transaction_date_idx")
  @@index([dueDate], name: "transaction_dueDate_idx")
  @@index([type], name: "transaction_type_idx")
  @@index([userId, date], name: "transaction_user_date_idx")
  @@index([userId, accountId, date], name: "transaction_user_account_date_idx")
  @@index([userId, investmentId, date], name: "transaction_user_investment_date_idx")
  @@index([transferGroupId], name: "transaction_transferGroupId_idx")
  @@map("transactions")
}

// Scheduled recurring transactions (subscriptions, salaries, etc.)
model RecurringTransaction {
  id         String             @id
  userId     String             @map("user_id")
  accountId  String             @map("account_id")
  categoryId String?            @map("category_id")
  type       TransactionType
  amount     Decimal            @db.Decimal(30, 10)
  currencyId String             @map("currency_id")
  frequency  RecurringFrequency
  nextDate   DateTime           @map("next_date")
  endDate    DateTime?          @map("end_date")
  note       String?
  created    DateTime           @default(now())
  modified   DateTime           @updatedAt

  currency Currency  @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  user     User      @relation("userRecurringTransactions", fields: [userId], references: [id], onDelete: Cascade)
  account  Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([userId], name: "recurringTransaction_userId_idx")
  @@index([currencyId], name: "recurringTransaction_currencyId_idx")
  @@index([nextDate], name: "recurringTransaction_nextDate_idx")
  @@map("recurring_transactions")
}

// Investment assets (stocks, crypto, custom investments)
model Investment {
  id             String              @id
  userId         String              @map("user_id")
  symbol         String
  name           String
  assetType      InvestmentAssetType @map("asset_type")
  mode           InvestmentMode      @default(priced)
  currencyId     String              @map("currency_id")
  baseCurrencyId String?             @map("base_currency_id")
  extra          Json?
  created        DateTime            @default(now())
  modified       DateTime            @updatedAt

  currency      Currency                 @relation("InvestmentCurrency", fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency  Currency?                @relation("InvestmentBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)
  user          User                     @relation("userInvestments", fields: [userId], references: [id], onDelete: Cascade)
  transactions  Transaction[]
  trades        InvestmentTrade[]
  holdings      Holding[]
  contributions InvestmentContribution[]
  valuations    InvestmentValuation[]

  @@index([userId], name: "investment_userId_idx")
  @@index([assetType], name: "investment_assetType_idx")
  @@index([symbol], name: "investment_symbol_idx")
  @@index([currencyId], name: "investment_currencyId_idx")
  @@index([baseCurrencyId], name: "investment_baseCurrencyId_idx")
  @@map("investments")
}

// Buy/sell trades for investment assets
model InvestmentTrade {
  id                   String    @id
  userId               String    @map("user_id")
  investmentId         String    @map("investment_id")
  accountId            String    @map("account_id")
  side                 TradeSide
  timestamp            DateTime
  price                Decimal   @db.Decimal(30, 10)
  quantity             Decimal   @db.Decimal(30, 10)
  amount               Decimal   @db.Decimal(30, 10)
  fee                  Decimal   @default(0) @db.Decimal(30, 10)
  currencyId           String    @map("currency_id")
  priceCurrency        String?   @map("price_currency")
  priceInBaseCurrency  Decimal?  @map("price_in_base_currency") @db.Decimal(30, 10)
  amountInBaseCurrency Decimal?  @map("amount_in_base_currency") @db.Decimal(30, 10)
  exchangeRate         Decimal?  @map("exchange_rate") @db.Decimal(30, 10)
  baseCurrencyId       String?   @map("base_currency_id")
  priceSource          String?   @map("price_source")
  priceFetchedAt       DateTime? @map("price_fetched_at")
  externalId           String?   @map("external_id")
  transactionId        String?   @unique @map("transaction_id")
  meta                 Json?

  created  DateTime @default(now())
  modified DateTime @updatedAt

  currency     Currency     @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency Currency?    @relation("TradeBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)
  user         User         @relation("userInvestmentTrades", fields: [userId], references: [id], onDelete: Cascade)
  investment   Investment   @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  account      Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  transaction  Transaction? @relation("TransactionTrade", fields: [transactionId], references: [id], onDelete: SetNull)

  @@index([userId, investmentId], name: "trade_user_investment_idx")
  @@index([investmentId, timestamp], name: "trade_investment_time_idx")
  @@index([currencyId], name: "trade_currencyId_idx")
  @@index([externalId], name: "trade_externalId_idx")
  @@index([baseCurrencyId], name: "trade_baseCurrencyId_idx")
  @@map("investment_trades")
}

// Deposits and withdrawals to/from investment accounts
model InvestmentContribution {
  id                   String           @id
  userId               String           @map("user_id")
  investmentId         String           @map("investment_id")
  accountId            String?          @map("account_id")
  amount               Decimal          @db.Decimal(30, 10)
  currencyId           String           @map("currency_id")
  type                 ContributionType @default(deposit)
  amountInBaseCurrency Decimal?         @map("amount_in_base_currency") @db.Decimal(30, 10)
  exchangeRate         Decimal?         @map("exchange_rate") @db.Decimal(30, 10)
  baseCurrencyId       String?          @map("base_currency_id")
  timestamp            DateTime
  note                 String?
  created              DateTime         @default(now())
  modified             DateTime         @updatedAt

  user         User       @relation("userInvestmentContributions", fields: [userId], references: [id], onDelete: Cascade)
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  account      Account?   @relation(fields: [accountId], references: [id], onDelete: SetNull)
  currency     Currency   @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency Currency?  @relation("ContributionBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)

  @@index([userId], name: "investmentContribution_userId_idx")
  @@index([investmentId], name: "investmentContribution_investmentId_idx")
  @@index([accountId], name: "investmentContribution_accountId_idx")
  @@index([currencyId], name: "investmentContribution_currencyId_idx")
  @@index([baseCurrencyId], name: "investmentContribution_baseCurrencyId_idx")
  @@map("investment_contributions")
}

// Historical price valuations for investments
model InvestmentValuation {
  id                  String    @id
  userId              String    @map("user_id")
  investmentId        String    @map("investment_id")
  currencyId          String    @map("currency_id")
  price               Decimal   @db.Decimal(30, 10)
  priceInBaseCurrency Decimal?  @map("price_in_base_currency") @db.Decimal(30, 10)
  exchangeRate        Decimal?  @map("exchange_rate") @db.Decimal(30, 10)
  baseCurrencyId      String?   @map("base_currency_id")
  timestamp           DateTime
  source              String?
  fetchedAt           DateTime? @map("fetched_at")

  created  DateTime @default(now())
  modified DateTime @updatedAt

  user         User       @relation("userInvestmentValuations", fields: [userId], references: [id], onDelete: Cascade)
  investment   Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  currency     Currency   @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  baseCurrency Currency?  @relation("ValuationBaseCurrency", fields: [baseCurrencyId], references: [id], onDelete: Restrict)

  @@index([userId], name: "investmentValuation_userId_idx")
  @@index([investmentId], name: "investmentValuation_investmentId_idx")
  @@index([currencyId], name: "investmentValuation_currencyId_idx")
  @@index([timestamp], name: "investmentValuation_timestamp_idx")
  @@index([baseCurrencyId], name: "investmentValuation_baseCurrencyId_idx")
  @@map("investment_valuations")
}

// Current holdings summary for each investment
model Holding {
  id                    String    @id
  userId                String    @map("user_id")
  investmentId          String    @map("investment_id")
  quantity              Decimal   @db.Decimal(30, 10)
  avgCost               Decimal   @map("avg_cost") @db.Decimal(30, 10)
  unrealizedPnl         Decimal?  @map("unrealized_pnl") @db.Decimal(30, 10)
  unrealizedPnlmodified DateTime? @map("unrealized_pnl_updated_at")
  lastPrice             Decimal?  @map("last_price") @db.Decimal(30, 10)
  lastPriceAt           DateTime? @map("last_price_at")
  created               DateTime  @default(now())
  modified              DateTime  @updatedAt

  user       User       @relation("userHoldings", fields: [userId], references: [id], onDelete: Cascade)
  investment Investment @relation(fields: [investmentId], references: [id], onDelete: Cascade)

  @@index([userId, investmentId], name: "holding_user_investment_idx")
  @@map("holdings")
}

// Budget plans with period-based tracking
model Budget {
  id        String       @id
  userId    String       @map("user_id")
  name      String
  amount    Decimal      @db.Decimal(30, 10)
  period    BudgetPeriod
  startDate DateTime     @map("start_date")
  endDate   DateTime?    @map("end_date")
  carryOver Boolean      @default(false) @map("carry_over")

  created  DateTime @default(now())
  modified DateTime @updatedAt

  user       User                 @relation("userBudgets", fields: [userId], references: [id], onDelete: Cascade)
  categories BudgetCategory[]
  accounts   BudgetAccount[]
  periods    BudgetPeriodRecord[]
  category   Category?            @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId String?

  @@index([userId], name: "budget_userId_idx")
  @@map("budgets")
}

// Categories associated with a budget
model BudgetCategory {
  id         String   @id @default(uuid(7))
  budgetId   String   @map("budget_id")
  categoryId String   @map("category_id")
  created    DateTime @default(now())

  budget   Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([budgetId, categoryId], name: "budget_category_unique")
  @@index([budgetId], name: "budget_category_budgetId_idx")
  @@index([categoryId], name: "budget_category_categoryId_idx")
  @@map("budget_categories")
}

// Accounts associated with a budget
model BudgetAccount {
  id        String   @id @default(uuid(7))
  budgetId  String   @map("budget_id")
  accountId String   @map("account_id")
  created   DateTime @default(now())

  budget  Budget  @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([budgetId, accountId], name: "budget_account_unique")
  @@index([budgetId], name: "budget_account_budgetId_idx")
  @@index([accountId], name: "budget_account_accountId_idx")
  @@map("budget_accounts")
}

// Historical period records for budget tracking
model BudgetPeriodRecord {
  id                String   @id
  budgetId          String   @map("budget_id")
  periodStartDate   DateTime @map("period_start_date")
  periodEndDate     DateTime @map("period_end_date")
  carriedOverAmount Decimal  @default(0) @map("carried_over_amount") @db.Decimal(30, 10)
  created           DateTime @default(now())
  modified          DateTime @updatedAt

  budget Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  @@unique([budgetId, periodStartDate], name: "budget_period_unique")
  @@index([budgetId], name: "budget_period_budgetId_idx")
  @@index([periodStartDate], name: "budget_period_startDate_idx")
  @@map("budget_periods")
}

// Savings goals with target amounts and timeframes
model Goal {
  id         String   @id
  userId     String   @map("user_id")
  name       String
  amount     Decimal  @db.Decimal(30, 10)
  currencyId String   @map("currency_id")
  startDate  DateTime @map("start_date")
  endDate    DateTime? @map("end_date")
  created    DateTime @default(now())
  modified   DateTime @updatedAt

  user       User         @relation("userGoals", fields: [userId], references: [id], onDelete: Cascade)
  currency   Currency     @relation(fields: [currencyId], references: [id], onDelete: Restrict)
  goalAccounts GoalAccount[]

  @@index([userId], name: "goal_userId_idx")
  @@index([startDate], name: "goal_startDate_idx")
  @@index([endDate], name: "goal_endDate_idx")
  @@map("goals")
}

// Junction table for many-to-many relationship between Goal and Account
model GoalAccount {
  id        String   @id @default(uuid(7))
  goalId    String   @map("goal_id")
  accountId String   @map("account_id")
  created   DateTime @default(now())

  goal    Goal    @relation(fields: [goalId], references: [id], onDelete: Cascade)
  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([goalId, accountId], name: "goal_account_unique")
  @@index([goalId], name: "goal_account_goalId_idx")
  @@index([accountId], name: "goal_account_accountId_idx")
  @@map("goal_accounts")
}

// User-defined tags for organizing transactions
model Tag {
  id          String  @id
  userId      String  @map("user_id")
  name        String
  description String?

  created  DateTime @default(now())
  modified DateTime @updatedAt

  user User @relation("userTags", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name], name: "tag_userId_name_unique")
  @@index([userId], name: "tag_userId_idx")
  @@index([name], name: "tag_name_idx")
  @@map("tags")
}

// Events for grouping transactions by time periods or occasions
model Event {
  id      String    @id
  userId  String    @map("user_id")
  name    String
  startAt DateTime  @map("start_at")
  endAt   DateTime? @map("end_at")

  created  DateTime @default(now())
  modified DateTime @updatedAt

  user         User          @relation("userEvents", fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name], name: "event_userId_name_unique")
  @@index([userId], name: "event_userId_idx")
  @@index([name], name: "event_name_idx")
  @@index([startAt], name: "event_startAt_idx")
  @@index([endAt], name: "event_endAt_idx")
  @@map("events")
}

// Contacts/entities for tracking transactions with people or organizations
model Entity {
  id       String     @id
  userId   String     @map("user_id")
  name     String
  type     EntityType @default(individual)
  phone    String?
  email    String?
  address  String?
  note     String?
  created  DateTime   @default(now())
  modified DateTime   @updatedAt

  user         User          @relation("userEntities", fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@unique([userId, name], name: "entity_userId_name_unique")
  @@index([userId], name: "entity_userId_idx")
  @@index([name], name: "entity_name_idx")
  @@index([type], name: "entity_type_idx")
  @@map("entities")
}

// Internationalization translations
model I18n {
  id  String  @id
  key String  @unique()
  en  String?
  vi  String?

  @@index([key])
  @@map("i18n")
}

// IP addresses allowed to access restricted resources
model IPWhitelist {
  id   String  @id
  ip   String  @unique
  note String?

  @@index([ip])
  @@map("ip_whitelist")
}

// Application configuration settings
model Setting {
  id          String  @id
  key         String  @unique
  value       String
  description String?
  isSecret    Boolean @default(false) @map("is_secret")

  type SettingDataType @default(string)

  @@index([key])
  @@map("settings")
}

// Proxy server configurations for external connections
model Proxy {
  id       String        @id
  protocol ProxyProtocol
  host     String
  port     Int
  username String
  password String
  enabled  Boolean       @default(true)
  modified DateTime      @updatedAt()
  created  DateTime      @default(now())

  @@unique([host, port, protocol, username, password])
  @@map("proxies")
}

model AuditLog {
  id            BigInt   @id
  payload       Json
  level         String
  logType       String   @map("log_type")
  userId        String?  @map("user_id")
  sessionId     String?  @map("session_id")
  ip            String?
  userAgent     String?  @map("user_agent")
  requestId     String?  @map("request_id")
  traceId       String?  @map("trace_id")
  correlationId String?  @map("correlation_id")
  occurredAt    DateTime @default(now()) @map("occurred_at")
  created       DateTime @default(now())

  @@index([created], map: "audit_log_created_idx")
  @@index([level], map: "audit_log_level_idx")
  @@index([logType], map: "audit_log_type_idx")
  @@index([userId, occurredAt(sort: Desc)], map: "audit_log_user_id_occurred_at_idx")
  @@index([sessionId, occurredAt(sort: Desc)], map: "audit_log_session_id_occurred_at_idx")
  @@index([traceId], map: "audit_log_trace_id_idx")
  @@index([correlationId], map: "audit_log_correlation_id_idx")
  @@map("audit_logs")
}

